const express = require('express')
const moment = require('moment')
const bcrypt = require('bcrypt')
const jwt = require('jsonwebtoken')
const auth = require('./middlewares/auth')
const PORT = process.env.PORT || 5000 ;
const TOKEN_KEY =process.env.TOKEN_KEY || "abdomagdy"
const app = express();
app.use(express.json())

const User = require("./models/user");
const post = require("./models/post")


// Register                    //           Ø¯Ù‡ Ø§Ù„ÙŠ Ù‡ÙˆÙ‡ Ù„Ø³Ù‡ Ù‡ÙŠØ¹Ù…Ù„ ÙŠÙˆØ²Ø± Ø¬Ø¯ÙŠØ¯

//   async :   ÙˆØ§Ù†Ù‡ ÙŠØ³ØªÙ†ÙŠ Ù„Ø­Ø¯ Ù…Ø§ ÙŠÙ†ÙØ° Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯Ù‡Ø§ ÙŠØ¯Ø®Ù„ Ø¹Ù„ÙŠ Ø§Ù„ÙŠ  Ø¨Ø¹Ø¯Ù‡ await Ø¯ÙŠ Ø¹Ù„Ø´Ø§Ù† Ø§Ù„     
app.post("/register",async (req, res) => {
    try {
        // Ø¯ÙŠ Ø§Ø®Ø¯Øª Ø§Ù„Ø¯Ø§ØªØ§ Ù…Ù† Ø§Ù„ÙŠÙˆØ²Ø± Ù…Ù† Ø§Ù„Ø¨Ø§Ø¯ÙŠ ÙˆØ­Ø·Øª ÙƒÙ„ Ù‚ÙŠÙ…Ù‡ ÙÙŠ Ø§Ø³Ù…Ù‡Ø§ 
        const { firstname, lastname, email, password } = req.body;
    
        //   Ø¯ÙŠ Ø§Ù†Ø§ Ù„Ø§Ø²Ù… Ø§ØªØ§ÙƒØ¯ Ø§Ù†Ù‡ Ø§Ø®Ø¯ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¯Ø®Ù„Ù‡Ø§ ØªØ¨Ù‚Ø§ Ù„Ù„Ø§Ø³ÙƒÙŠÙ…Ø§ Ù„Ùˆ ØªÙ…Ø§Ù… ÙŠÙƒÙ…Ù„ Ù„Ùˆ Ù…Ø´ ØªÙ…Ø§Ù… ÙŠÙ‚ÙˆÙ„Ù‡ Ù„Ø§ ÙƒÙ„ Ø§Ù„Ø¯Ø§ØªØ§ Ù…Ø·Ù„ÙˆØ¨Ù‡  
        if (!(email && password && firstname && lastname)) {
             res.status(400).send("All input is required");
             //console.log("error")
        }
    
         // Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ø¨Ù‚ÙˆÙ„Ù‡ Ù‡Ø§Øª Ø§Ù„ÙŠÙˆØ²Ø± Ø§Ù„ÙŠ Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ø¨ØªØ§Ø¹Ù‡ Ù†ÙØ³ Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ø§Ù„ÙŠ Ø¯Ø®Ù„Ù‡ Ø§Ù„ÙŠÙˆØ²Ø± Ù„Ùˆ Ù„Ù‚ÙŠØªÙ‡ Ù‡ØªØ¨Ù‚ÙŠ Ù‚ÙŠÙ…Ù‡
         // Ø§Ù„Ù…ØªØºÙŠØ± Ø¯Ù‡ Ø¨ØªØ±Ùˆ ÙˆÙÙŠ Ø§Ù„Ø­Ø§Ù„Ù‡ Ø¯ÙŠ ÙƒØ¯Ø§ ØºÙ„Ø· Ù„Ø§Ù† Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ ÙŠÙˆÙ†ÙŠÙƒ ÙˆÙ…Ø´ Ø¨ÙŠØªÙƒØ±Ø± ÙˆÙƒØ¯Ø§
         // Ø§ØªÙƒØ±Ø± ÙÙŠØ·Ù„Ø¹Ù„Ù‡ Ø§Ù† Ø¯Ø®Ù„ ØªØ§Ù†ÙŠ Ù„Ø§Ù† Ø§Ù†Ø§ Ù‡Ù†Ø§ Ø¨Ø¹Ù…Ù„ ÙƒØ±ÙŠØª Ù„ÙŠÙˆØ²Ø± Ø¬Ø¯ÙŠØ¯ Ù…ÙŠÙ†ÙØ¹Ø´ ÙŠØ¯Ø®Ù„ Ø§ÙŠÙ…ÙŠÙ„ Ø¯Ø®Ù„ Ù‚Ø¨Ù„ ÙƒØ¯Ø§ 
        // findOne({email:email})  Ø¯ÙŠ Ù‡ÙŠ Ù‡ÙŠ Ø§Ù„ÙŠ ØªØ­ØªÙ‡Ø§ 
        //awit Ø¯ÙŠ Ù‡Ù†Ø§ Ø¹Ù„Ø´Ø§Ù† ÙŠØ³ØªÙ†ÙŠ Ù„Ø­Ø¯ Ù…Ø§ ÙŠØ¬Ø¨Ù„Ù‡ Ø§Ù„Ø¯Ø§ØªØ§
        const oldUser = await User.findOne({ email });
         // Ù‡Ù†Ø§ Ø°ÙŠ Ù…Ø§ Ù‚ÙˆÙ„Ù†Ø§ Ù„Ùˆ Ø¯ÙŠ Ø¨ØªØ±Ùˆ ÙŠÙ‚ÙˆÙ„Ù‡ Ø¯Ø®Ù„ ØªØ§Ù†ÙŠ Ù„Ùˆ ØºÙ„Ø· ÙŠÙƒÙ…Ù„ Ø§Ù„Ø®Ø·ÙˆØ§Øª
        if (oldUser) {
          return res.status(409).send("User Already Exist. Please Login");
        }
          
        //Ø¯ÙŠ Ø§Ù„ÙŠ Ø¨Ø­ÙˆÙ„ ÙÙŠÙ‡Ø§ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù„Ù„ØªØ´ÙÙŠØ± Ø¨Ø­ÙŠØ« Ù„Ù…Ø§ Ø§Ù„ÙŠÙˆØ²Ø± ÙŠØ¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØªØªØ´ÙØ± Ø¨Ø¹Ø¯ ÙƒØ¯Ø§ ÙˆÙ…Ø­Ø¯Ø´ ÙŠØ´ÙˆÙ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØºÙŠØ±Ù‡ Ù‡ÙˆÙ‡ 
        // Ù‡Ù†Ø§ Ù‡ÙˆÙ‡ Ø¹Ù…Ù„ ØªØ´ÙÙŠØ± Ù„Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„ÙŠ Ø¯Ø®Ù„Ù‡ Ø§Ù„ÙŠÙˆØ²Ø± ÙÙŠ Ø§Ù„Ø¨Ø§Ø¯ÙŠ
        encryptedPassword = await bcrypt.hash(password, 10);
    
        // Ø§Ù†Ø§ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ù…Ø§ Ø§ØªØ§ÙƒØ¯ Ø§Ù† ÙƒÙ„ Ø­Ø§Ø¬Ù‡ ØµØ­ ÙˆØ§Ù„Ø¯Ù†ÙŠØ§ ØªÙ…Ø§Ù… ÙŠØ±ÙˆØ­ ÙŠØ¶ÙŠÙ Ø§Ù„ÙŠÙˆØ²Ø± Ø¨Ø¨ÙŠÙ†Ø§ØªÙ‡ ÙƒÙ„Ù‡Ø§ 
        const user = await User.create({
            firstname,
            lastname,
            email: email.toLowerCase(), // sanitize: convert email to lowercase
            // Ù‡Ù†Ø§ Ù‡ÙˆÙ‡ Ø¨ÙŠØ­Ø· Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø¨Ø¹Ø¯ Ù…Ø§ Ø¹Ù…Ù„Ù‡ ØªØ´ÙÙŠØ± 
            password: encryptedPassword,
        });
    
        //     environment variable Ø§Ù„ÙŠ Ø¨ØªØ´ÙØ± Ø¨ÙŠÙ‡ ÙˆØ·Ø¨Ø¹Ø§ Ø¯Ù‡ Ù‚ÙŠÙ…ØªÙ‡ Ù…Ø´ Ø¨Ø§Ø®Ø¯Ù‡Ø§ Ø§Ù†Ø§ Ø¨Ø¹Ø±ÙÙ‡Ø§ Ù„Ù„Ø³ÙŠØ±ÙØ± Ø¨ØªØ§Ø¹ÙŠ Ù…Ù† Ø¶Ù…Ù† Ø§Ù„  key  ÙˆØ¨Ø¹Ø¯ ÙƒØ¯Ø§ Ø§Ø¯ÙŠØªÙ‡Ø§ Ø§Ù„  id ,email Ù‡Ù†Ø§ Ø§Ù†Ø§ Ø¹Ù…Ù„Øª ØªÙˆÙƒÙ† ÙˆØ§Ù„Ø¯Ø§ØªØ§ Ø¨ØªØ§Ø¹ØªÙ‡ Ù‡ÙŠ Ø§Ù„ 
        const token = jwt.sign(
          { user_id: user._id, email },
          TOKEN_KEY
        );
        // Ù‡Ù†Ø§ Ø¨Ù‚ÙˆÙ„Ù‡ Ø³ÙŠÙ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„ÙŠ Ø§ØªÙƒØ±ÙŠØª Ø¨Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„ÙŠ Ù…ØªØ³Ø¬Ù„ Ù…Ø¹ Ø§Ù„ÙŠÙˆØ²Ø± Ù†ÙØ³Ù‡ Ù„Ø§Ù† ÙÙŠÙ‡ ØªÙˆÙƒÙ† Ø§Ù†Ø§ Ø¹Ø§Ù…Ù„Ù‡ Ù…ØªØºÙŠØ± Ù…Ø¹ Ø§Ù„ÙŠÙˆØ²Ø± ÙÙŠ Ø§Ù„Ø§Ø³ÙƒÙŠÙ…Ø§ 
        user.token = token;
    
        // Ù‡Ù†Ø§ Ø¨Ù‚ÙˆÙ„Ù‡ Ø±Ø¯ Ø¹Ù„ÙŠØ§ Ø¨Ø§Ù„ÙŠÙˆØ²Ø± Ø§Ù„ÙŠ Ø¹Ù…Ù„ØªÙ„Ù‡ ÙƒØ±ÙŠØª 
        res.status(201).json(user);  


      } catch (err) {         //     catch  Ù‡ÙŠØ¯Ø®Ù„ ÙŠÙ†ÙØ° Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„   try Ø¯Ù‡ Ø·Ø¨Ø¹Ø§ Ù„Ùˆ ÙÙŠÙ‡ Ø­Ø§Ø¬Ù‡ ØºÙ„Ø· ÙÙŠ Ø§Ù„ 
        console.log(err);
      }
});


 // Login          //  Ø¯Ù‡ Ø¹Ù†Ø¯ÙŠ ÙŠÙˆØ²Ø± ÙˆÙ‡Ø¹Ù…Ù„ Ù„ÙˆØ¬Ù† 

app.post("/login", async (req, res) => {
    try {
        //                Ø§Ù„ÙŠ Ø¯Ø®Ù„Ù‡Ù… Ø§Ù„ÙŠÙˆØ²Ø± ÙÙŠ Ø§Ù„Ø¨Ø§Ø¯ÙŠ   email,pass  Ø¯Ù‡ Ø¨Ù‚ÙˆÙ„Ù‡ Ù‡Ø§Øª 
        const { email, password } = req.body;
    
        // Ù‡Ù†Ø§ Ø¨ØªØ§ÙƒØ¯ Ø§Ù†Ù‡ Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙˆØ§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ù„Ø§Ù† Ù„Ùˆ Ù…Ø¯Ø®Ù„Ø´ Ø­Ø§Ø¬Ù‡ ÙÙŠÙ‡Ù… Ø¨Ù‚ÙˆÙ„Ù‡ ÙƒÙ„Ù‡Ù… Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†
        if (!(email && password)) {
          res.status(400).send("All input is required");
        }

        // Ù‡Ù†Ø§ Ø¨Ù‚ÙŠ Ø¨Ø¹Ù…Ù„ Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ø§Ù„ÙŠ Ø¯Ø®Ù„ Ù‡Ù„ Ù‡ÙˆÙ‡ Ù‡ÙˆÙ‡ Ø§Ù„ÙŠ Ø¹Ù†Ø¯ÙŠ ÙˆØ¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ„Ø§ Ù„Ø§ Ù„Ø§Ù†Ù‡ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ ÙŠÙƒÙ…Ù„ Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙŠØ¨Ù‚ÙŠ ØºÙ„Ø·
        const user = await User.findOne({ email });
          // ÙÙŠ Ø§Ù„Ø§ÙˆÙ„ Ø¨ØªØ§ÙƒØ¯ Ø§Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„ÙŠ ÙÙˆÙ‚ Ø¨ØªØ±Ùˆ ÙˆØ§Ù†Ù‡ Ù„Ù‚ÙŠ Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø¨Ø¹Ù…Ù„ Ù…Ù‚Ø§Ø±Ù†Ù‡ Ø¨Ø§Ù†Ù‡ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù†ÙØ³ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„ÙŠ Ø¯Ø®Ù„ 
        if (user && (await bcrypt.compare(password, user.password))) {
          // Ø§Ù†Ø§ Ù‡Ù†Ø§ Ø¨Ø¹Ù…Ù„ ÙƒØ±ÙŠØª Ù„Ù„ØªÙˆÙƒÙ† Ù…Ø±Ù‡ ØªØ§Ù†ÙŠÙ‡ ÙˆÙ‡ÙˆÙ‡ Ù…Ø´ Ø´Ø±Ø· Ø§Ù†Ø§ Ù…Ù…ÙƒÙ† Ø§Ø¹Ù…Ù„Ù‡Ø§ Ù…Ø±Ù‡
          // ÙˆØ§Ø­Ø¯Ù‡ Ø¨Ø³ Ø³ÙˆØ§Ø¡ Ø±ÙŠØ¬Ø³ØªØ± Ø§Ùˆ Ù„ÙˆØ¬Ù† Ø­Ø³Ø¨ Ø§Ù„Ù„ÙˆØ¬ÙŠÙƒ Ø¨ØªØ§Ø¹ÙŠ ÙˆÙ‚ØªÙ‡Ø§ Ø§Ù†Ø§ Ù‡Ù†Ø§ ÙƒØ±ÙŠØª ØªÙˆÙƒÙ† ÙˆØ­Ø·ÙŠØª Ù‚ÙŠÙ…ØªÙ‡ ÙÙŠ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙŠÙˆØ²Ø± Ù†ÙØ³Ù‡ 
          const token = jwt.sign(
            { user_id: user._id, email },
            TOKEN_KEY
          );
            
          // Ù‡Ù†Ø§ Ø¹Ù…Ù„Øª Ø³ÙŠÙ Ù„Ù„ØªÙˆÙƒÙ†
          user.token = token;
    
          // Ù‡Ù†Ø§ Ø¨Ø±Ø¬Ø¹ Ø§Ù„ÙŠÙˆØ²Ø± Ø§Ù„ÙŠ Ø¹Ù…Ù„ Ù„ÙˆØ¬Ù†
          res.status(200).json(user);
        } 
        res.status(400).send("Invalid Credentials");   // Ù‡Ù†Ø§ Ø¨Ù‚ÙˆÙ„Ù‡ Ù„Ùˆ Ø­Ø§Ø¬Ù‡ Ù…Ù† Ø§Ù„ÙŠ ÙÙˆÙ‚ ØºÙ„Ø· Ù‚ÙˆÙ„Ù‡ Ø§Ù† ÙƒØ¯Ø§ ØºÙ„Ø· ÙˆÙ…Ø´ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø´Ø±ÙˆØ· 
      } 
      catch (err) {         // catch  Ù‡ÙŠØ¯Ø®Ù„ ÙŠÙ†ÙØ° Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„   try Ø¯Ù‡ Ø·Ø¨Ø¹Ø§ Ù„Ùˆ ÙÙŠÙ‡ Ø­Ø§Ø¬Ù‡ ØºÙ„Ø· ÙÙŠ Ø§Ù„ 
        console.log(err);
      }
});
                //  Ù‡Ù†Ø§ Ø¨Ù‚ÙŠ Ù„Ùˆ ÙƒÙ„Ù‡ ØªÙ…Ø§Ù… Ø¹Ù…Ù„ Ø§Ù„Ø§ÙŠÙ…Ù„ ÙˆÙƒÙ„Ù‡ ØµØ­ ÙˆØ¹Ù…Ù„ Ù„ÙˆØ¬Ù† ÙˆÙƒÙ„Ù‡
                // ØµØ­ Ø§Ø¯Ø®Ù„ Ù‡Ù†Ø§ Ø¯Ù‡ Ø§Ù„ÙŠ Ù‡ÙˆÙ‡ ÙŠØ¹Ù…Ù„ ÙØ±ÙÙƒØ§Ø´Ù† Ù„ÙƒÙ„ Ø±ÙŠÙƒÙˆÙŠØ³Øª Ù…Ø¨Ø¹ÙˆØª Ù…Ù† Ø§Ù„ÙŠÙˆØ²Ø± ÙŠØªØ§ÙƒØ¯ ÙÙŠÙ‡Ø§ Ø§Ù†Ù‡ Ø§Ù„ÙŠÙˆØ²Ø± Ø¯Ù‡ Ø¹Ø§Ù…Ù„ Ù„ÙˆØ¬Ù†
                // ÙŠØ¹Ù†ÙŠ Ù„Ø§Ø²Ù… Ø§Ø¹Ù…Ù„ Ø¯ÙŠ ÙˆØ§Ù„ÙŠ Ù‡ÙˆÙ‡ Ø¨Ø¹Ø¯Ù‡Ø§ Ø§Ø¹Ù…Ù„ Ù†ÙŠÙƒØ³Øª Ø¹Ù„ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ø¹Ø¯ Ø§Ù„ÙØ§Ù†ÙƒØ´Ù† Ø§Ù„ÙŠ Ø¬Ø§ÙŠÙ‡ Ù„Ø³Ù‡ 



   //  Ø¹Ù„ÙŠ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„ÙŠ Ù…Ø¨Ø¹ÙˆØª Ù…Ù†  viryfy  Ù‡Ù†Ø§ Ø¨Ù†ÙØ° Ø§Ù„Ù…ÙŠØ¯ÙŠÙ„ ÙˆÙŠØ± Ø§Ù„ÙŠ Ù‡ÙŠØ¹Ù…Ù„ 
   //     Ø§Ù„Ø±ÙŠÙƒÙˆÙŠØ³Øª Ø¨Ø­ÙŠØ« Ø§Ù†Ù‡ ÙŠØªØ§ÙƒØ¯ Ø§Ù† Ø§Ù„ØªÙˆÙƒÙ† Ø¯Ù‡ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨ØªØ§Ø¹ÙŠ Ø¹Ù…Ù„Ù‡ Ù‚Ø¨Ù„ ÙƒØ¯Ø§ ÙˆÙ„Ø§ Ù„Ø§ Ù„Ùˆ Ø¹Ù…Ù„Ù‡ ØªÙ…Ø§Ù… ÙˆÙ„Ùˆ Ù„Ø§ ÙŠÙ‚ÙˆÙ„Ù‡ ØºÙ„Ø· Ø¯Ù‡ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø¯ÙŠ 
  
   //  Ø¯ÙŠ Ø§Ø³Ù… Ø§Ù„ÙØ§Ù†ÙƒØ´Ù† Ø§Ù„ÙŠ Ø¨ÙŠÙ†ÙØ°Ù‡Ø§ Ø¬ÙˆÙ‡ ØµÙØ­Ù‡ Ø§Ù„Ù…ÙŠØ¯ÙŠÙ„ ÙˆÙŠØ±   auth Ø§Ù„ 
   //  ÙˆÙ„Ùˆ Ù†ÙØ° ÙÙŠÙ‡Ø§ ÙƒÙ„ Ø­Ø§Ø¬Ù‡ ØµØ­ Ù‡ÙŠØ¬ÙŠ ÙŠÙ†ÙØ° Ø§Ù„Ø³Ø·Ø± Ø¨ØªØ§Ø¹ ÙˆÙŠÙ„ÙƒÙ… Ù„Ùˆ ØºÙ„Ø· Ù…Ù† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠÙ‚ÙˆÙ„Ù‡ ÙÙŠÙ‡ Ù…Ø´ÙƒÙ„Ù‡ 
   app.use("/Welcome",auth , (req,res) => {
      
    //res.send(req.user.iduser_id)
    //res.send(req.user.user_id)
    post.find({auther:req.user.user_id},(err,userr) => {
         if(!err) return res.json(userr)
          res.send("error")
      }).populate("auther")
   // res.status(200).send(req.user)
    console.log(" â™¥â™¥â™¥â™¥â™¥â™¥â™¥   Welcome ðŸ™Œ â™¥â™¥â™¥â™¥â™¥â™¥â™¥â™¥ ")
});









// app.use((req,res,next) => {
//     console.log(moment().format('MMMM Do YYYY, h:mm:ss a'))
//     next()
// })

const userroutes = require ('./routes/user')
const postroutes = require ('./routes/post')
app.use('/user',userroutes)
app.use('/post',postroutes)



const mongoose = require('mongoose')
mongoose.connect("mongodb://127.0.0.1:27017/userAndposts",(err)=>
{
    if(!err) return console.log("databases connect successfuly");
    console.log(err)
})

app.listen(PORT,(err)=>{
    if(!err) return console.log("server connect successfuly");
    console.log(err) 
})


